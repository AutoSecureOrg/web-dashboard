<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Services</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #0c1b37;
            color: #f0f0f0;
        }

        .all-button,
        .service-button {
            display: inline-block;
            margin: 5px;
            border: none;
            border-radius: 8px;
            padding: 12px 15px;
            background-color: #ffcc00;
            color: #0c1b37;
            cursor: pointer;
            transition: all 0.3s;
        }

        .all-button:hover,
        .all-button.active,
        .service-button:hover,
        .service-button.active {
            background-color: #ff5c33;
            color: white;
        }

        .ip-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #12264d;
            border-radius: 8px;
        }

        .ip-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            text-align: center;
        }

        #loading-spinner {
            display: none;
            margin-top: 10px;
        }

        #progress-log {
            margin-top: 20px;
            font-style: italic;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h1 class="text-center">Select Services to Run Tests</h1>
        <form method="POST" action="/run-tests" id="service-form">

            <!-- Add Testing Mode Selection -->
            <div class="text-center mt-4">
                <h5>Select Testing Mode:</h5>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="testing_mode" id="lite-mode" value="Lite" checked>
                    <label class="form-check-label" for="lite-mode">Lite Testing</label>
                    <small class="form-text text-muted">(Fast - Runs one exploit per service)</small>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="testing_mode" id="deep-mode" value="Deep">
                    <label class="form-check-label" for="deep-mode">Deep Testing</label>
                    <small class="form-text text-muted">(Thorough - Runs all available exploits)</small>
                </div>
            </div>

            <div class="mt-4 mb-3 text-center">
                <button type="button" id="select-all-button" class="all-button">Select All</button>
            </div>

            <div id="services-container">
                {% for ip, services in services.items() %}
                <div class="ip-section">
                    <div class="ip-title">IP Address: {{ ip }}</div>
                    <div class="d-flex flex-wrap justify-content-center">
                        {% for service in services %}
                        <div class="service-button" data-service="{{ service.service }}" data-port="{{ service.port }}"
                            data-ip="{{ ip }}">
                            {{ service.service }} (Port {{ service.port }})
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <input type="hidden" id="selected-services" name="services" value="">

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-success" id="run-tests-button">Run Tests</button>
                <div id="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p id="progress-log">Preparing to run tests...</p>
                </div>
            </div>
        </form>
    </div>

    <script>
        const serviceButtons = document.querySelectorAll('.service-button');
        const selectedServicesInput = document.getElementById('selected-services');
        const runTestsButton = document.getElementById('run-tests-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const progressLog = document.getElementById('progress-log');
        let selectAllState = false;
        // Add testing mode radios
        const testingModeRadios = document.querySelectorAll('input[name="testing_mode"]');

        const funFacts = [
            "Cybersecurity is a $150 billion industry.",
            "Every 39 seconds, there is a new cyberattack somewhere in the world.",
            "The first computer virus was created in 1986.",
            "There are over 1 million unfilled cybersecurity jobs worldwide.",
            "The largest DDoS attack in history occurred in 2020, reaching 2.5 terabits per second."
        ];

        // Toggle individual service buttons
        serviceButtons.forEach(button => {
            button.addEventListener('click', () => {
                button.classList.toggle('active');
                updateSelectedServices();
            });
        });

        // Update hidden input with selected services
        function updateSelectedServices() {
            const selected = Array.from(document.querySelectorAll('.service-button.active'))
                .map(button => ({
                    ip: button.getAttribute('data-ip'),
                    service: button.getAttribute('data-service'),
                    port: button.getAttribute('data-port')
                }));
            selectedServicesInput.value = JSON.stringify(selected);
        }

        // Select/Deselect All button logic
        function selectAll() {
            selectAllState = !selectAllState; // Toggle state
            const selectAllButton = document.getElementById('select-all-button');

            if (selectAllState) {
                serviceButtons.forEach(button => button.classList.add('active'));
                selectAllButton.textContent = "Deselect All";
            } else {
                serviceButtons.forEach(button => button.classList.remove('active'));
                selectAllButton.textContent = "Select All";
            }
            updateSelectedServices();
        }

        // Add Event Listener for Select All Button
        document.getElementById('select-all-button').addEventListener('click', selectAll);

        // Form submission and loading spinner
        document.getElementById('service-form').addEventListener('submit', (e) => {
            e.preventDefault();
            runTestsButton.style.display = 'none';
            loadingSpinner.style.display = 'block';

            const formData = new FormData(e.target);
            // Append selected testing mode
            const selectedMode = document.querySelector('input[name="testing_mode"]:checked').value;
            formData.append('testing_mode', selectedMode);

            fetch('/run-tests', {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    startPollingForStatus();
                    startFunFactsRotation();
                } else {
                    progressLog.textContent = 'Error starting tests. Please try again.';
                }
            }).catch(error => {
                console.error('Error starting tests:', error);
                progressLog.textContent = 'An error occurred. Please try again.';
            });
        });

        // Polling for test completion
        function startPollingForStatus() {
            function checkStatus() {
                fetch('/check-status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.complete) {
                            progressLog.textContent = 'Tests complete. Redirecting to results...';
                            setTimeout(() => {
                                window.location.href = "/results"; // Redirect to the results page
                            }, 2000);
                        } else {
                            setTimeout(checkStatus, 2000);
                        }
                    })
                    .catch(error => {
                        console.error('Error checking status:', error);
                        setTimeout(checkStatus, 2000);
                    });
            }
            checkStatus();
        }

        // Fun facts rotation
        function startFunFactsRotation() {
            let funFactIndex = 0;

            function rotateFunFacts() {
                if (progressLog.textContent === 'Tests complete. Redirecting to results...') {
                    return;
                }
                progressLog.textContent = funFacts[funFactIndex];
                funFactIndex = (funFactIndex + 1) % funFacts.length;
                setTimeout(rotateFunFacts, 4000);
            }

            rotateFunFacts();
        }
    </script>
</body>

</html>